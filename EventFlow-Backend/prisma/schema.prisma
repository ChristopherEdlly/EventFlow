// Prisma schema para User e Event
// Conectado ao Supabase (PostgreSQL)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id               String    @id @default(uuid())
  name             String
  email            String    @unique
  password         String?   // Opcional para login OAuth
  role             String    @default("USER") // USER, ADMIN

  // OAuth providers
  authProvider     String    @default("LOCAL") // LOCAL, GOOGLE
  googleId         String?   @unique

  // Email verification
  emailVerified    Boolean   @default(false)
  verificationCode String?
  verificationExpires DateTime?
  pendingEmail     String?   // Novo email aguardando verificação

  // Ban system
  isBanned         Boolean   @default(false)
  bannedAt         DateTime?
  bannedUntil      DateTime?
  banReason        String?

  events           Event[]   @relation("OwnerEvents")
  guests           Guest[]
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
  reports          Report[]  @relation("ReportedBy")
  penalties        Penalty[]
  notifications    Notification[]
  pushSubscriptions PushSubscription[]
  createdAt        DateTime  @default(now())
}

model Event {
  id             String        @id @default(uuid())
  title          String
  description    String?
  date           DateTime
  time           String
  endDate        DateTime?
  endTime        String?
  location       String
  visibility     String
  availability   String        @default("PUBLISHED") // PUBLISHED, ARCHIVED, COMPLETED
  rsvpDeadline   DateTime?
  capacity       Int?
  waitlistEnabled Boolean      @default(false)
  showGuestList  Boolean       @default(false)
  timezone       String?

  // Novos campos essenciais
  category       String        @default("OUTRO") // CONFERENCIA, WORKSHOP, PALESTRA, FESTA, ESPORTIVO, CULTURAL, EDUCACIONAL, NETWORKING, CORPORATIVO, BENEFICENTE, OUTRO
  eventType      String        @default("PRESENCIAL") // PRESENCIAL, ONLINE, HIBRIDO
  price          Float         @default(0) // 0 = gratuito
  minAge         Int?
  imageUrl       String?
  onlineUrl      String?
  tags           String?       // JSON array ou string separada por vírgulas

  // Moderation system
  isHidden       Boolean       @default(false)
  hiddenReason   String?
  hiddenAt       DateTime?
  reportCount    Int           @default(0)

  ownerId        String
  owner          User          @relation("OwnerEvents", fields: [ownerId], references: [id])
  guests         Guest[]
  announcements  Announcement[]
  messages       Message[]
  reports        Report[]
  notifications  Notification[]
  createdAt      DateTime      @default(now())
}

model Guest {
  id          String    @id @default(uuid())
  name        String
  email       String
  status      String    // PENDING, YES, NO, MAYBE, WAITLISTED
  eventId     String
  event       Event     @relation(fields: [eventId], references: [id])
  userId      String?
  user        User?     @relation(fields: [userId], references: [id])
  respondedAt DateTime? // Data e hora da última alteração de status
  createdAt   DateTime  @default(now())
}

model Announcement {
  id        String   @id @default(uuid())
  message   String
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id])
  createdBy String
  createdAt DateTime @default(now())
}

model Message {
  id         String   @id @default(uuid())
  content    String
  senderId   String
  sender     User     @relation("SentMessages", fields: [senderId], references: [id])
  receiverId String
  receiver   User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
  eventId    String
  event      Event    @relation(fields: [eventId], references: [id])
  read       Boolean  @default(false)
  createdAt  DateTime @default(now())
}

model Report {
  id         String       @id @default(uuid())
  eventId    String
  event      Event        @relation(fields: [eventId], references: [id], onDelete: Cascade)
  reportedBy String
  reporter   User         @relation("ReportedBy", fields: [reportedBy], references: [id])
  reason     String // SPAM, INAPPROPRIATE, FRAUD, SCAM, MISLEADING, HARASSMENT, OTHER
  details    String?
  status     String @default("PENDING") // PENDING, REVIEWED, ACCEPTED, REJECTED
  reviewedBy String?
  reviewedAt DateTime?
  reviewNotes String?
  createdAt  DateTime     @default(now())

  @@unique([eventId, reportedBy]) // Um usuário só pode denunciar cada evento uma vez
}

model Penalty {
  id        String      @id @default(uuid())
  userId    String
  user      User        @relation(fields: [userId], references: [id])
  type      String // WARNING, SUSPENSION, BAN
  reason    String
  details   String?
  duration  Int?        // dias (null = permanente para BAN)
  expiresAt DateTime?
  isActive  Boolean     @default(true)
  createdBy String      // ID do admin que aplicou
  createdAt DateTime    @default(now())
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type      String   // EVENT_INVITE, EVENT_REMINDER, EVENT_UPDATE, EVENT_CANCELLED, RSVP_RESPONSE, NEW_MESSAGE, ANNOUNCEMENT, SYSTEM
  title     String
  message   String
  
  // Referências opcionais
  eventId   String?
  event     Event?   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  // Metadados
  data      String?  // JSON com dados extras
  actionUrl String?  // URL para redirecionar ao clicar
  
  // Status
  read      Boolean  @default(false)
  readAt    DateTime?
  
  // Push notification tracking
  pushSent  Boolean  @default(false)
  pushSentAt DateTime?
  
  createdAt DateTime @default(now())
  
  @@index([userId, read])
  @@index([userId, createdAt])
}

model PushSubscription {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // FCM Token
  fcmToken  String   @unique
  
  // Device info
  deviceType String?  // web, android, ios
  deviceName String?
  
  isActive  Boolean  @default(true)
  lastUsed  DateTime @default(now())
  createdAt DateTime @default(now())
  
  @@index([userId])
}
